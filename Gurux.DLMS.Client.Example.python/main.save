
import os
import sys
import traceback
from gurux_serial import GXSerial
from gurux_net import GXNet
from gurux_dlms.enums import ObjectType
from gurux_dlms.objects.GXDLMSObjectCollection import GXDLMSObjectCollection
from GXSettings import GXSettings
from GXDLMSReader import GXDLMSReader
from gurux_dlms.GXDLMSClient import GXDLMSClient
from gurux_common.GXCommon import GXCommon
from gurux_dlms.enums.DataType import DataType
import locale
from gurux_dlms.GXDateTime import GXDateTime
from gurux_dlms.internal._GXCommon import _GXCommon
from gurux_dlms import GXDLMSException, GXDLMSExceptionResponse, GXDLMSConfirmedServiceError, GXDLMSTranslator
from gurux_dlms import GXByteBuffer, GXDLMSTranslatorMessage, GXReplyData
from gurux_dlms.enums import RequestTypes, Security, InterfaceType
from gurux_dlms.secure.GXDLMSSecureClient import GXDLMSSecureClient



import json
from pymongo import MongoClient

import json
import xmltodict

client = MongoClient("mongodb://smartmeter:Yn%237298802%23@170.187.149.194/?authMechanism=DEFAULT")
db = client['countries_db']
collection_currency = db['currency']





try:
    import pkg_resources
    #pylint: disable=broad-except
except Exception:
    #It's OK if this fails.
    print("pkg_resources not found")

#pylint: disable=too-few-public-methods,broad-except
class sampleclient():
    @classmethod
    def main(cls, args):
        try:
            print("gurux_dlms version: " + pkg_resources.get_distribution("gurux_dlms").version)
            print("gurux_net version: " + pkg_resources.get_distribution("gurux_net").version)
            print("gurux_serial version: " + pkg_resources.get_distribution("gurux_serial").version)
        except Exception:
            #It's OK if this fails.
            print("pkg_resources not found")

        # args: the command line arguments
        reader = None
        settings = GXSettings()
        try:
            # //////////////////////////////////////
            #  Handle command line parameters.
            ret = settings.getParameters(args)
            if ret != 0:
                return
            # //////////////////////////////////////
            #  Initialize connection settings.
            if not isinstance(settings.media, (GXSerial, GXNet)):
                raise Exception("Unknown media type.")
            # //////////////////////////////////////
            reader = GXDLMSReader(settings.client, settings.media, settings.trace, settings.invocationCounter)
            settings.media.open()
            print(settings.readObjects)
            if settings.readObjects:
                
                read = False
                reader.initializeConnection()
                print('________main_sucess6')
                if settings.outputFile and os.path.exists(settings.outputFile):
                    try:
                        c = GXDLMSObjectCollection.load(settings.outputFile)
                        settings.client.objects.extend(c)
                        if settings.client.objects:
                            read = True
                            print('________main_sucess')

                    except Exception:
                        print('________main_sucess2')
                        read = False
                if not read:
                    print('________main_sucess3')
                    reader.getAssociationView()
                for k, v in settings.readObjects:
                    print('________main_sucess5')
                    obj = settings.client.objects.findByLN(ObjectType.NONE, k)
                    if obj is None:
                        raise Exception("Unknown logical name:" + k)
                    val = reader.read(obj, v)
                    reader.showValue(v, val)
                if settings.outputFile:
                    settings.client.objects.save(settings.outputFile)
            else:
                print('________main_sucess4')
                reader.readAll(settings.outputFile)
                with open('/var/www/gurux_yash/Gurux.DLMS.Client.Example.python/device.xml') as xml_file:
                        data_dict = xmltodict.parse(xml_file.read())
                        xml_file.close()

                        collection_currency.insert_one(data_dict)
                        # if pymongo >= 3.0 use insert_many() for inserting many documents
                        #collection_currency.insert_many(file_data)
                        print('sent data to mongodb sucessfully')
                        client.close()

        except (ValueError, GXDLMSException, GXDLMSExceptionResponse, GXDLMSConfirmedServiceError) as ex:
            print(ex)
        except (KeyboardInterrupt, SystemExit, Exception) as ex:
            traceback.print_exc()
            if settings.media:
                settings.media.close()
            reader = None
        finally:
            if reader:
                try:
                    reader.close()
                except Exception:
                    traceback.print_exc()
            print("Ended. Press any key to continue.")

if __name__ == '__main__':
   
    sampleclient.main(sys.argv)
